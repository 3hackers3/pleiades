

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pleiades.helpers &mdash; Pleiades Documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script>
        <script type="text/javascript" src="../../_static/katex_autorenderer.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/katex-math.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> pleiades
          

          
            
            <img src="../../_static/pleiades_logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickinstall.html">Quick Install Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pythonapi/index.html">Python API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources.html">Resources and Reference Material</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pleiades</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pleiades.helpers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pleiades.helpers</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">interp1d</span><span class="p">,</span> <span class="n">interp2d</span><span class="p">,</span> <span class="n">RectBivariateSpline</span><span class="p">,</span><span class="n">UnivariateSpline</span><span class="p">,</span><span class="n">griddata</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">Delaunay</span><span class="p">,</span> <span class="n">ConvexHull</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="k">import</span> <span class="n">LineCollection</span>
<span class="kn">from</span> <span class="nn">pleiades.math</span> <span class="k">import</span> <span class="n">get_gpsi</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="k">import</span> <span class="n">splprep</span><span class="p">,</span><span class="n">splev</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="k">import</span> <span class="n">fmin</span>
<span class="kn">from</span> <span class="nn">matplotlib.path</span> <span class="k">import</span> <span class="n">Path</span>
<span class="c1">#import analysis.datahelpers as dh</span>

<div class="viewcode-block" id="Boundary"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.Boundary">[docs]</a><span class="k">class</span> <span class="nc">Boundary</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vertices</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interpolate_verts</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_interpolate_verts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vertices</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">npts</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="n">tck</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="n">splprep</span><span class="p">(</span><span class="n">vertices</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">u_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">u</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">npts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tck</span> <span class="o">=</span> <span class="n">tck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u_new</span>
        <span class="n">r_new</span><span class="p">,</span><span class="n">z_new</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">u_new</span><span class="p">,</span><span class="n">tck</span><span class="p">,</span><span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r_new</span><span class="p">,</span><span class="n">z_new</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

<div class="viewcode-block" id="Boundary.interpolate"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.Boundary.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">splev</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tck</span><span class="p">,</span><span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="FieldLine"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine">[docs]</a><span class="k">class</span> <span class="nc">FieldLine</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">psi</span><span class="p">,</span><span class="n">verts</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="n">psi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verts</span> <span class="o">=</span> <span class="n">verts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interpolate_verts</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reorder_verts</span><span class="p">()</span>

<div class="viewcode-block" id="FieldLine.is_closed"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.is_closed">[docs]</a>    <span class="k">def</span> <span class="nf">is_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verts</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span></div>

    <span class="k">def</span> <span class="nf">_interpolate_verts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">npts</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="n">per</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">per</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tck</span><span class="p">,</span><span class="n">u</span> <span class="o">=</span> <span class="n">splprep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_verts</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="n">s</span><span class="p">,</span><span class="n">per</span><span class="o">=</span><span class="n">per</span><span class="p">)</span>
        <span class="n">u_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span><span class="n">u</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span><span class="n">npts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tck</span> <span class="o">=</span> <span class="n">tck</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">u_new</span>
        <span class="n">r_new</span><span class="p">,</span><span class="n">z_new</span> <span class="o">=</span> <span class="n">splev</span><span class="p">(</span><span class="n">u_new</span><span class="p">,</span><span class="n">tck</span><span class="p">,</span><span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r_new</span><span class="p">,</span><span class="n">z_new</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

<div class="viewcode-block" id="FieldLine.interpolate"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.interpolate">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">u</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">splev</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">tck</span><span class="p">,</span><span class="n">der</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="FieldLine.reorder_verts"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.reorder_verts">[docs]</a>    <span class="k">def</span> <span class="nf">reorder_verts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">steptol</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_closed</span><span class="p">():</span>
            <span class="n">istart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">tmpvert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="p">,</span><span class="o">-</span><span class="n">istart</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tmpvert</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">tmpvert</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">tmpvert</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">tmpvert</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">steptol</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">tmpvert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">tmpvert</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">verts</span> <span class="o">=</span> <span class="n">tmpvert</span></div>

<div class="viewcode-block" id="FieldLine.get_svec"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.get_svec">[docs]</a>    <span class="k">def</span> <span class="nf">get_svec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">r</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="FieldLine.get_length"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.get_length">[docs]</a>    <span class="k">def</span> <span class="nf">get_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_svec</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="FieldLine.get_ds"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.get_ds">[docs]</a>    <span class="k">def</span> <span class="nf">get_ds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span><span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span></div>

<div class="viewcode-block" id="FieldLine.interpolate_onto"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.interpolate_onto">[docs]</a>    <span class="k">def</span> <span class="nf">interpolate_onto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">griddata</span><span class="p">((</span><span class="n">R</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">Z</span><span class="o">.</span><span class="n">ravel</span><span class="p">()),</span><span class="n">Q</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span><span class="n">xi</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span></div>

<div class="viewcode-block" id="FieldLine.get_kappa_n"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.get_kappa_n">[docs]</a>    <span class="k">def</span> <span class="nf">get_kappa_n</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">BR</span><span class="p">,</span><span class="n">BZ</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">):</span>
        <span class="n">modB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">BR</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">BZ</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">bhatr</span><span class="p">,</span> <span class="n">bhatz</span> <span class="o">=</span> <span class="n">BR</span><span class="o">/</span><span class="n">modB</span><span class="p">,</span> <span class="n">BZ</span><span class="o">/</span><span class="n">modB</span>
        <span class="n">bhatr_terp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_onto</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">bhatr</span><span class="p">)</span>
        <span class="n">bhatz_terp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_onto</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">bhatz</span><span class="p">)</span>
        <span class="n">signb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">bhatr_terp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">verts</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">bhatz_terp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">kap_r</span><span class="p">,</span> <span class="n">kap_z</span> <span class="o">=</span> <span class="n">signb</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">d_ds</span><span class="p">(</span><span class="n">bhatr_terp</span><span class="p">),</span> <span class="n">signb</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">d_ds</span><span class="p">(</span><span class="n">bhatz_terp</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kap_r</span><span class="p">,</span> <span class="n">kap_z</span></div>

<div class="viewcode-block" id="FieldLine.d_ds"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.d_ds">[docs]</a>    <span class="k">def</span> <span class="nf">d_ds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">Q</span><span class="p">):</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ds</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">Q</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span> <span class="o">-</span> <span class="n">Q</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ds</span><span class="p">)</span>
        <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">ds</span>
        <span class="n">res</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">Q</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">ds</span> 
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="FieldLine.get_gradpsi"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.get_gradpsi">[docs]</a>    <span class="k">def</span> <span class="nf">get_gradpsi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">BR</span><span class="p">,</span><span class="n">BZ</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">):</span>
        <span class="n">gradpsi_r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate_onto</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">R</span><span class="o">*</span><span class="n">BZ</span><span class="p">)</span>
        <span class="n">gradpsi_z</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">interpolate_onto</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">R</span><span class="o">*</span><span class="n">BR</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gradpsi_r</span><span class="p">,</span><span class="n">gradpsi_z</span></div>

<div class="viewcode-block" id="FieldLine.intersection"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.intersection">[docs]</a>    <span class="k">def</span> <span class="nf">intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">boundary</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_distfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">boundary</span><span class="p">,</span><span class="n">s1</span><span class="p">,</span><span class="n">s2</span><span class="p">):</span>
            <span class="n">rfl</span><span class="p">,</span><span class="n">zfl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
            <span class="n">rb</span><span class="p">,</span><span class="n">zb</span> <span class="o">=</span> <span class="n">boundary</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">s2</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">rfl</span><span class="o">-</span><span class="n">rb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">zfl</span><span class="o">-</span><span class="n">zb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">distfunc</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x0</span><span class="p">:</span> <span class="n">_distfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">boundary</span><span class="p">,</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">fmin</span><span class="p">(</span><span class="n">distfunc</span><span class="p">,[</span><span class="o">.</span><span class="mi">5</span><span class="p">,</span><span class="o">.</span><span class="mi">5</span><span class="p">],</span><span class="n">disp</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="FieldLine.apply_boundary"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.apply_boundary">[docs]</a>    <span class="k">def</span> <span class="nf">apply_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">b1</span><span class="p">,</span><span class="n">b2</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ubound0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ubound1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">b2</span><span class="p">)</span></div>

<div class="viewcode-block" id="FieldLine.get_bounded_fl"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.FieldLine.get_bounded_fl">[docs]</a>    <span class="k">def</span> <span class="nf">get_bounded_fl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">npts</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ubound0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ubound1</span><span class="p">,</span><span class="n">npts</span><span class="p">))</span></div></div>

<div class="viewcode-block" id="contour_points"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.contour_points">[docs]</a><span class="k">def</span> <span class="nf">contour_points</span><span class="p">(</span><span class="n">contourset</span><span class="p">):</span>
    <span class="n">condict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">ilev</span><span class="p">,</span> <span class="n">lev</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">contourset</span><span class="o">.</span><span class="n">levels</span><span class="p">):</span>
        <span class="n">condict</span><span class="p">[</span><span class="n">lev</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">FieldLine</span><span class="p">(</span><span class="n">lev</span><span class="p">,</span><span class="n">seg</span><span class="p">)</span> <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">contourset</span><span class="o">.</span><span class="n">allsegs</span><span class="p">[</span><span class="n">ilev</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">condict</span></div>

<div class="viewcode-block" id="regular_grid"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.regular_grid">[docs]</a><span class="k">def</span> <span class="nf">regular_grid</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span><span class="n">yy</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;nx&quot;</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">ny</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ny&quot;</span><span class="p">,</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;xi&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;yi&quot;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot; interpolate irregularly gridded data onto regular grid.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">yi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xx</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">xx</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">yy</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">ny</span><span class="p">)</span>
        <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>

    <span class="c1">#then, interpolate your data onto this grid:</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">zs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">zi</span> <span class="o">=</span> <span class="n">griddata</span><span class="p">(</span><span class="n">points</span><span class="p">,</span><span class="n">z</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">),</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="n">zs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zi</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_deltapsi"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.get_deltapsi">[docs]</a><span class="k">def</span> <span class="nf">get_deltapsi</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">Req</span><span class="p">,</span><span class="n">Zeq</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Returns contribution to psi from fast ion currents.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (netcdf4 Dataset object)</span>
<span class="sd">        Req (2D R grid from eqdsk)</span>
<span class="sd">        Zeq (2D Z grid from eqdsk)</span>

<span class="sd">    Returns:</span>
<span class="sd">        deltapsi (psi from fast ion currents on eqdsk grid)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">variables</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dimensions</span>
    <span class="n">nrj</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="s2">&quot;nreqadim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="n">nzj</span> <span class="o">=</span> <span class="n">dims</span><span class="p">[</span><span class="s2">&quot;nzeqadim&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Req</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Req</span><span class="p">),</span><span class="n">nrj</span><span class="p">)</span>
    <span class="n">zeq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Zeq</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Zeq</span><span class="p">),</span><span class="n">nzj</span><span class="p">)</span>
    <span class="n">dr</span><span class="p">,</span><span class="n">dz</span> <span class="o">=</span> <span class="n">req</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">req</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">zeq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">zeq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rr</span><span class="p">,</span><span class="n">zz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">req</span><span class="p">,</span><span class="n">zeq</span><span class="p">)</span>
    <span class="n">gpsi_jphi</span> <span class="o">=</span> <span class="n">get_gpsi</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="n">zz</span><span class="p">)</span>
    <span class="n">jphi</span> <span class="o">=</span> <span class="n">var</span><span class="p">[</span><span class="s2">&quot;curr_diamcurv_phi&quot;</span><span class="p">][:]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jphi</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">jphi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jphi</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">jphi</span><span class="o">*=</span><span class="mf">1E4</span> <span class="c1"># A/cm^2 to A/m^2</span>
    <span class="n">Iphi</span> <span class="o">=</span> <span class="n">jphi</span><span class="o">*</span><span class="n">dr</span><span class="o">*</span><span class="n">dz</span>
    <span class="n">deltapsi</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpsi_jphi</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Iphi</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">rr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">deltapsi</span> <span class="o">=</span> <span class="n">regular_grid</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span><span class="n">zz</span><span class="p">,</span><span class="n">deltapsi</span><span class="p">,</span><span class="n">xi</span><span class="o">=</span><span class="n">Req</span><span class="p">,</span><span class="n">yi</span><span class="o">=</span><span class="n">Zeq</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">deltapsi</span></div>

<div class="viewcode-block" id="poly_fit"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.poly_fit">[docs]</a><span class="k">def</span> <span class="nf">poly_fit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">order</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">m</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">basis_fns</span> <span class="o">=</span> <span class="p">[(</span><span class="k">lambda</span> <span class="n">z</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">z</span><span class="o">**</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">m</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">basis_fns</span><span class="p">[</span><span class="n">j</span><span class="p">](</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">vt</span><span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="n">Sinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">m</span><span class="p">))</span>
    <span class="n">s</span><span class="p">[</span> <span class="n">s</span><span class="o">&lt;</span><span class="mf">1.0e-10</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">s</span><span class="p">[</span> <span class="n">s</span><span class="o">&gt;=</span><span class="mf">1.0e-10</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">s</span><span class="p">[</span> <span class="n">s</span><span class="o">&gt;=</span><span class="mf">1.0e-10</span><span class="p">]</span>
    <span class="n">Sinv</span><span class="p">[:</span><span class="n">n</span><span class="p">,:</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Sinv</span><span class="p">,</span><span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vt</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">c</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">basis_fns</span><span class="p">,</span><span class="n">c</span></div>

<div class="viewcode-block" id="reflect_and_hstack"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.reflect_and_hstack">[docs]</a><span class="k">def</span> <span class="nf">reflect_and_hstack</span><span class="p">(</span><span class="n">Rho</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reflect and concatenate grid and quantities in *args to plot both half planes (rho&gt;=0 and rho&lt;=0).</span>

<span class="sd">    Note: Currently this function only reflects across the z axis since that is the symmetry convention</span>
<span class="sd">        we&#39;ve taken for the machine.</span>

<span class="sd">    Args:</span>
<span class="sd">        Rho (2D array): rho grid</span>
<span class="sd">        Z (2D array): z grid</span>
<span class="sd">        *args (2D arrays), any quantity on this grid you wish to plot in both half planes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Rho_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="o">-</span><span class="n">Rho</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">Rho</span><span class="p">))</span>
    <span class="n">Z_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">Z</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">Z</span><span class="p">))</span>
    <span class="n">arglist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">arg</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">Rho</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">arglist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">arg</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">arg</span><span class="p">)))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">Rho_total</span><span class="p">,</span><span class="n">Z_total</span><span class="p">)</span><span class="o">+</span><span class="nb">tuple</span><span class="p">(</span><span class="n">arglist</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_concave_hull"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.get_concave_hull">[docs]</a><span class="k">def</span> <span class="nf">get_concave_hull</span><span class="p">(</span><span class="n">Rho</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Q</span><span class="p">):</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">rho0</span><span class="p">,</span><span class="n">z0</span><span class="p">]</span> <span class="k">for</span> <span class="n">rho0</span><span class="p">,</span><span class="n">z0</span><span class="p">,</span><span class="n">q</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Rho</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">Z</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">Q</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span> <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">q</span><span class="p">)])</span>
    <span class="n">tri</span> <span class="o">=</span> <span class="n">Delaunay</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

    <span class="c1"># Make a list of line segments: </span>
    <span class="c1"># edge_points = [ ((x1_1, y1_1), (x2_1, y2_1)),</span>
    <span class="c1">#                 ((x1_2, y1_2), (x2_2, y2_2)),</span>
    <span class="c1">#                 ... ]</span>
    <span class="n">edge_points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add_edge</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a line between the i-th and j-th points, if not in the list already&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">edges</span> <span class="ow">or</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
        <span class="c1"># already added</span>
            <span class="k">return</span>
        <span class="n">edges</span><span class="o">.</span><span class="n">add</span><span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">edge_points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">[</span> <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="p">])</span>

    <span class="c1"># loop over triangles: </span>
    <span class="c1"># ia, ib, ic = indices of corner points of the triangle</span>
    <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">ib</span><span class="p">,</span> <span class="n">ic</span> <span class="ow">in</span> <span class="n">tri</span><span class="o">.</span><span class="n">vertices</span><span class="p">:</span>
        <span class="n">add_edge</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">ib</span><span class="p">)</span>
        <span class="n">add_edge</span><span class="p">(</span><span class="n">ib</span><span class="p">,</span> <span class="n">ic</span><span class="p">)</span>
        <span class="n">add_edge</span><span class="p">(</span><span class="n">ic</span><span class="p">,</span> <span class="n">ia</span><span class="p">)</span>

    <span class="c1"># plot it: the LineCollection is just a (maybe) faster way to plot lots of</span>
    <span class="c1"># lines at once</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">edge_points</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Delaunay triangulation&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="c1">#plt.plot(points[:,0], points[:,1], &#39;o&#39;, hold=1)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="transform_to_rtheta"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.transform_to_rtheta">[docs]</a><span class="k">def</span> <span class="nf">transform_to_rtheta</span><span class="p">(</span><span class="n">Rho</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">rho_component</span><span class="p">,</span><span class="n">z_component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transform Rho Z grid and rho,z components of vector field to polar coordinates&quot;&quot;&quot;</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">Rho</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">Z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span><span class="n">Rho</span><span class="p">)</span>
    <span class="n">sin_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Theta</span><span class="p">)</span>
    <span class="n">cos_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Theta</span><span class="p">)</span>
    <span class="n">r_component</span> <span class="o">=</span> <span class="n">rho_component</span><span class="o">*</span><span class="n">sin_t</span> <span class="o">+</span> <span class="n">z_component</span><span class="o">*</span><span class="n">cos_t</span>
    <span class="n">theta_component</span> <span class="o">=</span> <span class="n">rho_component</span><span class="o">*</span><span class="n">cos_t</span> <span class="o">-</span> <span class="n">z_component</span><span class="o">*</span><span class="n">sin_t</span>
    <span class="k">return</span> <span class="n">R</span><span class="p">,</span><span class="n">Theta</span><span class="p">,</span><span class="n">r_component</span><span class="p">,</span><span class="n">theta_component</span> </div>

<div class="viewcode-block" id="transform_to_rhoz"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.transform_to_rhoz">[docs]</a><span class="k">def</span> <span class="nf">transform_to_rhoz</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Theta</span><span class="p">,</span><span class="n">r_component</span><span class="p">,</span><span class="n">theta_component</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transform R Theta grid and r theta components of vector field to cylindrical coordinates&quot;&quot;&quot;</span>
    <span class="n">Rho</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Theta</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">Theta</span><span class="p">)</span>
    <span class="n">rho_component</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_component</span><span class="o">*</span><span class="n">Rho</span> <span class="o">+</span> <span class="n">theta_component</span><span class="o">*</span><span class="n">Z</span><span class="p">)</span><span class="o">/</span><span class="n">R</span>
    <span class="n">z_component</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_component</span><span class="o">*</span><span class="n">Z</span> <span class="o">-</span> <span class="n">theta_component</span><span class="o">*</span><span class="n">Rho</span><span class="p">)</span><span class="o">/</span><span class="n">R</span>
    <span class="k">return</span> <span class="n">Rho</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">rho_component</span><span class="p">,</span><span class="n">z_component</span> </div>

<div class="viewcode-block" id="locs_to_vals"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.locs_to_vals">[docs]</a><span class="k">def</span> <span class="nf">locs_to_vals</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">coord_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Picks values of field Q at desired coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (2D array): grid representing column coordinates of Q</span>
<span class="sd">        Y (2D array): grid representing row coordinates of Q</span>
<span class="sd">        Q (2D array): value of Q on grid</span>
<span class="sd">        coord_list (list):list of tuples (x,y) for desired coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">coord_list</span><span class="p">:</span>
        <span class="n">x0_idx</span><span class="p">,</span><span class="n">y0_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">-</span><span class="n">x</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Y</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">y</span><span class="p">))</span>
        <span class="n">q_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">y0_idx</span><span class="p">,</span><span class="n">x0_idx</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">q_vals</span></div>

<div class="viewcode-block" id="locs_to_vals_griddata"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.locs_to_vals_griddata">[docs]</a><span class="k">def</span> <span class="nf">locs_to_vals_griddata</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">coord_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Picks values of field Q at desired coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (2D array): grid representing column coordinates of Q</span>
<span class="sd">        Y (2D array): grid representing row coordinates of Q</span>
<span class="sd">        Q (2D array): value of Q on grid</span>
<span class="sd">        coord_list (list):list of tuples (x,y) for desired coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xi</span><span class="p">,</span><span class="n">yi</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">coord_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">griddata</span><span class="p">((</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">Y</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span><span class="n">Q</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">))</span></div>

<div class="viewcode-block" id="locs_to_vals1D"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.locs_to_vals1D">[docs]</a><span class="k">def</span> <span class="nf">locs_to_vals1D</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">coord_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Picks values of field Q at desired coordinates.</span>

<span class="sd">    Args:</span>
<span class="sd">        X (2D array): grid representing column coordinates of Q</span>
<span class="sd">        Y (2D array): grid representing row coordinates of Q</span>
<span class="sd">        Q (2D array): value of Q on grid</span>
<span class="sd">        coord_list (list):list of tuples (x,y) for desired coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">q_vals</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">coord_list</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">Y</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">q_vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">q_vals</span></div>

<div class="viewcode-block" id="get_fieldlines"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.get_fieldlines">[docs]</a><span class="k">def</span> <span class="nf">get_fieldlines</span><span class="p">(</span><span class="n">contourset</span><span class="p">,</span><span class="n">level</span><span class="p">,</span><span class="n">start_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clockwise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">idx_check</span><span class="o">=</span><span class="p">[]):</span>
    <span class="sd">&quot;&quot;&quot;Return coordinates for segments comprising a flux surface (Nx2 array).</span>

<span class="sd">    Args:</span>
<span class="sd">        contourset (matplotlib.contour.QuadContourSet instance): i.e.</span>
<span class="sd">        ax.contour call</span>
<span class="sd">        level (float): desired contour level</span>
<span class="sd">        start_coord (tuple): coordinate (x,y) at which to start the field line</span>
<span class="sd">        end_coord (tuple): coordinate (x,y) at which to end the field line</span>
<span class="sd">        clockwise (bool): whether to order the field line coordinates clockwise or</span>
<span class="sd">        counterclockwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## Find desired flux surface and get its vertices</span>
    <span class="k">assert</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">contourset</span><span class="o">.</span><span class="n">levels</span><span class="p">),</span> <span class="s2">&quot;level: </span><span class="si">{0}</span><span class="s2"> not found in contourset&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">contourset</span><span class="o">.</span><span class="n">levels</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">level</span><span class="p">)</span>
    <span class="n">segs</span> <span class="o">=</span> <span class="n">contourset</span><span class="o">.</span><span class="n">allsegs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="n">len_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segs</span><span class="p">]</span>
    <span class="n">max_idx</span> <span class="o">=</span> <span class="n">len_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">len_list</span><span class="p">))</span>
    <span class="n">flpoints</span> <span class="o">=</span> <span class="n">parse_segment</span><span class="p">(</span><span class="n">segs</span><span class="p">[</span><span class="n">max_idx</span><span class="p">],</span><span class="n">start_coord</span><span class="o">=</span><span class="n">start_coord</span><span class="p">,</span><span class="n">end_coord</span><span class="o">=</span><span class="n">end_coord</span><span class="p">,</span><span class="n">clockwise</span><span class="o">=</span><span class="n">clockwise</span><span class="p">)</span>
<span class="c1">#    if idx in idx_check:</span>
<span class="c1">#        fig_pts,ax_pts = plt.subplots()</span>
<span class="c1">#        fig_B,ax_B = plt.subplots()</span>
<span class="c1">#        for i,pts in enumerate(segs):</span>
<span class="c1">#            tmp_pts = parse_segment(pts,start_coord=start_coord,end_coord=end_coord,clockwise=clockwise)</span>
<span class="c1">#            ax_pts.plot(tmp_pts[:,0],tmp_pts[:,1],&quot;o&quot;)</span>
<span class="c1">#            ax_pts.plot(tmp_pts[0,0],tmp_pts[0,1],&quot;go&quot;)</span>
<span class="c1">#            ax_pts.plot(tmp_pts[-1,0],tmp_pts[-1,1],&quot;ro&quot;)</span>
<span class="c1">#            ax_pts.set_xlim(0,2.50)</span>
<span class="c1">#            ax_pts.set_ylim(-1.25,1.25)</span>
<span class="c1">#            ax_pts.set_aspect(1)</span>
<span class="c1">#            B_interp = interp(Rho,Z,B,tmp_pts)</span>
<span class="c1">#            s = get_fieldline_distance(tmp_pts)</span>
<span class="c1">#            ax_B.plot(s,B_interp,&quot;o&quot;)</span>
<span class="c1">#        plt.show()</span>
    <span class="k">return</span> <span class="n">flpoints</span></div>

<div class="viewcode-block" id="parse_segment"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.parse_segment">[docs]</a><span class="k">def</span> <span class="nf">parse_segment</span><span class="p">(</span><span class="n">flpoints</span><span class="p">,</span><span class="n">start_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">end_coord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clockwise</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">start_coord</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y0</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flpoints</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">start_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">flpoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">start_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span>
        <span class="n">flpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">flpoints</span><span class="p">,</span><span class="o">-</span><span class="n">i_start</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1">## Find out if curve is cw or ccw</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">flpoints</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">flpoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">iscw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">clockwise</span> <span class="o">!=</span> <span class="n">iscw</span><span class="p">:</span>
        <span class="n">flpoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">flpoints</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span><span class="mi">1</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">i_end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">end_coord</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">i_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y0</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">x0</span><span class="p">,</span><span class="n">y0</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flpoints</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">end_coord</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">flpoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">end_coord</span><span class="p">[</span><span class="mi">1</span><span class="p">])]))</span>
        <span class="k">if</span> <span class="n">i_end</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">i_end</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">flpoints</span> <span class="o">=</span> <span class="n">flpoints</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">i_end</span><span class="p">,:]</span>
    <span class="k">return</span> <span class="n">flpoints</span></div>

<div class="viewcode-block" id="get_fieldline_distance"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.get_fieldline_distance">[docs]</a><span class="k">def</span> <span class="nf">get_fieldline_distance</span><span class="p">(</span><span class="n">flpoints</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return cumulative field line distance vector</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">flpoints</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">flpoints</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">flpoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">s</span></div>

<div class="viewcode-block" id="interp"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.interp">[docs]</a><span class="k">def</span> <span class="nf">interp</span><span class="p">(</span><span class="n">Rho</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">flpoints</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;interpolate quantity Q on Rho, Z grid onto flpoints (Nx2 array of x,y pairs).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">Rho</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">Z</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">Q</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">yi</span><span class="p">,</span><span class="n">xi</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">xi</span><span class="p">,</span><span class="n">yi</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">flpoints</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">flpoints</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])])</span></div>

<div class="viewcode-block" id="flux_surface_avg"><a class="viewcode-back" href="../../pythonapi/helpers.html#pleiades.helpers.flux_surface_avg">[docs]</a><span class="k">def</span> <span class="nf">flux_surface_avg</span><span class="p">(</span><span class="n">Rho</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">flpoints</span><span class="p">,</span><span class="n">Q</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute flux surface average of quantity Q or return dVdpsi (dl_B)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## Interpolate B and quantity Q onto flux line</span>
    <span class="n">B_interp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">Rho</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">flpoints</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">get_fieldline_distance</span><span class="p">(</span><span class="n">flpoints</span><span class="p">)</span>
    <span class="n">dl_B</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">B_interp</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Q</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">Q_interp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="n">Rho</span><span class="p">,</span><span class="n">Z</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">flpoints</span><span class="p">)</span>
        <span class="n">fsa</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dl_B</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">Q_interp</span><span class="o">/</span><span class="n">B_interp</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fsa</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dl_B</span></div>

<div class="viewcode-block" id="diff_central"><a class="viewcode-back" href="../../pythonapi/generated/pleiades.html#pleiades.helpers.diff_central">[docs]</a><span class="k">def</span> <span class="nf">diff_central</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
    <span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="o">*</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span></div>

<span class="c1"># need to remove datahelpers dependency from this before using</span>
<span class="c1">#def get_F(Rho,Z,psi,B,min_rho,max_rho,start_coord=None,end_coord=None,clockwise=True,plotit=False,dfl_tol=.1):</span>
<span class="c1">#    gamma = 5.0/3.0</span>
<span class="c1">#    figf,axf = plt.subplots()</span>
<span class="c1">#    psi_min,psi_edge = locs_to_vals(Rho,Z,psi,[(min_rho,0),(max_rho,0)])</span>
<span class="c1">#    psi_levels = np.linspace(psi_min,psi_edge,500)</span>
<span class="c1">#    cff = axf.contour(Rho,Z,psi,tuple(psi_levels))</span>
<span class="c1">#    dl_B_list = []</span>
<span class="c1">#    for psi0 in psi_levels:</span>
<span class="c1">#        if psi0 == 0.0:</span>
<span class="c1">#            flpoints = get_fieldlines(cff,psi0,start_coord=start_coord,end_coord=end_coord,clockwise=False)</span>
<span class="c1">#        else:</span>
<span class="c1">#            flpoints = get_fieldlines(cff,psi0,start_coord=start_coord,end_coord=end_coord,clockwise=clockwise)</span>
<span class="c1">#        s = get_fieldline_distance(flpoints)</span>
<span class="c1">#        if np.max(s[1:]-s[0:-1]) &gt; dfl_tol:</span>
<span class="c1">#            raise ValueError(&quot;fieldline distance between successive points greater than dfl_tol: {0}m&quot;.format(dfl_tol))</span>
<span class="c1">#        if plotit:</span>
<span class="c1">#            x,y = flpoints[:,0],flpoints[:,1]</span>
<span class="c1">#            axf.plot(x,y,&#39;bo&#39;)</span>
<span class="c1">#            axf.plot(x[0],y[0],&#39;go&#39;)</span>
<span class="c1">#            axf.plot(x[-1],y[-1],&#39;ro&#39;)</span>
<span class="c1">#        dl_B_list.append(flux_surface_avg(Rho,Z,B,flpoints))</span>
<span class="c1">#    psi_new = psi_levels</span>
<span class="c1">#    dl_B_new = np.array(dl_B_list)</span>
<span class="c1">#    dl_B_new = dh.smooth(dl_B_new,5,mode=&quot;valid&quot;)</span>
<span class="c1">#    psi_new = dh.smooth(psi_new,5,mode=&quot;valid&quot;)</span>
<span class="c1">#    U = UnivariateSpline(psi_new,dl_B_new,k=4,s=0)</span>
<span class="c1">#    dUdpsi = UnivariateSpline(psi_new[1:-1],diff_central(psi_new,dl_B_new),k=1,s=0,ext=&quot;const&quot;)</span>
<span class="c1">#    d2Udpsi2 = UnivariateSpline(psi_new[2:-2],diff_central(psi_new[1:-1],diff_central(psi_new,dl_B_new)),k=1,s=0,ext=&quot;const&quot;)</span>
<span class="c1">#    #dUdpsi = UnivariateSpline(psi_new[1:-1],diff_central(psi_new,dl_B_new),k=3,s=0,ext=&quot;const&quot;)</span>
<span class="c1">#    #d2Udpsi2 = UnivariateSpline(psi_new[2:-2],diff_central(psi_new[1:-1],diff_central(psi_new,dl_B_new)),k=3,s=0,ext=&quot;const&quot;)</span>
<span class="c1">#    term1 = lambda x: gamma*x/U(x)*(dUdpsi(x))**2</span>
<span class="c1">#    term2 = lambda x: dUdpsi(x) + x*d2Udpsi2(x)</span>
<span class="c1">#    F = lambda x: term1(x) - term2(x)</span>
<span class="c1">#    if plotit:</span>
<span class="c1">#        z0_idx = np.abs(Z[:,0]).argmin()</span>
<span class="c1">#        end_idx = np.abs(Rho[z0_idx,:]-max_rho).argmin()</span>
<span class="c1">#        R_of_psi = UnivariateSpline(psi[z0_idx,0:end_idx],Rho[z0_idx,0:end_idx],s=0)</span>
<span class="c1">#        psi_test = np.linspace(psi_min,psi_edge,1000)</span>
<span class="c1">#        psi_norm = psi_test/psi_edge</span>
<span class="c1">#        fig9,(ax9a,ax9b,ax9c) = plt.subplots(3,1,sharex=&quot;col&quot;)</span>
<span class="c1">#        ax9a.plot(psi_new,dl_B_new,&quot;o&quot;)</span>
<span class="c1">#        ax9a.plot(psi_test,U(psi_test),&quot;r&quot;)</span>
<span class="c1">#        ax9b.plot(psi_new[1:-1],dUdpsi(psi_new[1:-1]),&quot;o&quot;)</span>
<span class="c1">#        ax9b.plot(psi_test,dUdpsi(psi_test),&quot;r&quot;)</span>
<span class="c1">#        ax9c.plot(psi_new[2:-2],d2Udpsi2(psi_new[2:-2]),&quot;o&quot;)</span>
<span class="c1">#        ax9c.plot(psi_test,d2Udpsi2(psi_test),&quot;r&quot;)</span>
<span class="c1">#        fig0,((ax0,ax1),(ax2,ax3)) = plt.subplots(2,2,sharex=&quot;all&quot;,figsize=(18,9))</span>
<span class="c1">#        ax0.plot(psi_new/psi_edge,dl_B_new,&quot;o&quot;)</span>
<span class="c1">#        ax0.plot(psi_norm,U(psi_test),lw=2)</span>
<span class="c1">#        ax0.set_ylabel(&quot;U&quot;)</span>
<span class="c1">#        ax0top = ax0.twiny()</span>
<span class="c1">#        new_labels = [&quot;{0:1.2f}&quot;.format(r) for r in R_of_psi(psi_edge*np.array(ax0.get_xticks()))]</span>
<span class="c1">#        ax0top.set_xticklabels(new_labels)</span>
<span class="c1">#        ax0top.set_xlabel(&quot;R (m)&quot;)</span>
<span class="c1">#        ax1.plot(psi_norm,dUdpsi(psi_test),&#39;o&#39;)</span>
<span class="c1">#        ax1.set_ylabel(&quot;U&#39;&quot;)</span>
<span class="c1">#        ax1top = ax1.twiny()</span>
<span class="c1">#        ax1top.set_xticklabels(new_labels)</span>
<span class="c1">#        ax1top.set_xlabel(&quot;R (m)&quot;)</span>
<span class="c1">#        ax2.plot(psi_norm,term1(psi_test),&#39;o&#39;)</span>
<span class="c1">#        ax2.plot(psi_norm,term2(psi_test),&#39;o&#39;)</span>
<span class="c1">#        ax2.set_xlabel(&quot;$\\psi/\\psi_{lim}$&quot;)</span>
<span class="c1">#        ax2.set_ylabel(&quot;Term1 and term2&quot;)</span>
<span class="c1">#        F_clean = dh.smooth(F(psi_test),20)</span>
<span class="c1">#        ax3.plot(psi_norm,F_clean,lw=2)</span>
<span class="c1">#        ax3.set_xlabel(&quot;$\\psi/\\psi_{lim}$&quot;)</span>
<span class="c1">#        ax3.set_ylabel(&quot;F($\\psi$)&quot;)</span>
<span class="c1">#        #ax3.set_ylim(-1.2,1.2)</span>
<span class="c1">#        plt.tight_layout()</span>
<span class="c1">#    return F</span>

<span class="c1"># Added by Roger some simple check for field lines looping back on them selves</span>
<span class="c1"># def get_F_v2(Rho,Z,psi,B,min_rho,max_rho,start_coord=None,end_coord=None,clockwise=True,plotit=False,plotdots=True,thresh=.2,num_psi=500):</span>
<span class="c1">#     gamma = 5.0/3.0</span>
<span class="c1">#     figf,axf = plt.subplots()</span>
<span class="c1">#     psi_min,psi_edge = locs_to_vals(Rho,Z,psi,[(min_rho,0),(max_rho,0)])</span>
<span class="c1">#     psi_levels = np.linspace(psi_min,psi_edge,num_psi)</span>
<span class="c1">#     cff = axf.contour(Rho,Z,psi,tuple(psi_levels))</span>
<span class="c1">#     dl_B_list = []</span>
<span class="c1">#     for psi0 in psi_levels:</span>
<span class="c1">#         if psi0 == 0.0:</span>
<span class="c1">#             flpoints = get_fieldlines(cff,psi0,start_coord=start_coord,end_coord=end_coord,clockwise=False)</span>
<span class="c1">#         else:</span>
<span class="c1">#             flpoints = get_fieldlines(cff,psi0,start_coord=start_coord,end_coord=end_coord,clockwise=clockwise)</span>
<span class="c1">#             if np.abs(flpoints[0][0]-start_coord[0]) &gt; thresh:</span>
<span class="c1">#                 raise ValueError(&quot;I think some of these contours start after the separatrix.&quot;)</span>
<span class="c1">#         if plotdots:</span>
<span class="c1">#             x,y = flpoints[:,0],flpoints[:,1]</span>
<span class="c1">#             axf.plot(x,y,&#39;bo&#39;)</span>
<span class="c1">#             axf.plot(x[0],y[0],&#39;go&#39;)</span>
<span class="c1">#             axf.plot(x[-1],y[-1],&#39;ro&#39;)</span>
<span class="c1">#         else:</span>
<span class="c1">#             plt.close()</span>
<span class="c1">#         dl_B_list.append(flux_surface_avg(Rho,Z,B,flpoints))</span>
<span class="c1">#     psi_new = psi_levels</span>
<span class="c1">#     dl_B_new = np.array(dl_B_list)</span>
<span class="c1">#     dl_B_new = dh.smooth(dl_B_new,5,mode=&quot;valid&quot;)</span>
<span class="c1">#     psi_new = dh.smooth(psi_new,5,mode=&quot;valid&quot;)</span>
<span class="c1">#     U = UnivariateSpline(psi_new,dl_B_new,k=4,s=0)</span>
<span class="c1">#     dUdpsi = UnivariateSpline(psi_new[1:-1],diff_central(psi_new,dl_B_new),k=1,s=0,ext=&quot;const&quot;)</span>
<span class="c1">#     d2Udpsi2 = UnivariateSpline(psi_new[2:-2],diff_central(psi_new[1:-1],diff_central(psi_new,dl_B_new)),k=1,s=0,ext=&quot;const&quot;)</span>
<span class="c1">#     #dUdpsi = UnivariateSpline(psi_new[1:-1],diff_central(psi_new,dl_B_new),k=3,s=0,ext=&quot;const&quot;)</span>
<span class="c1">#     #d2Udpsi2 = UnivariateSpline(psi_new[2:-2],diff_central(psi_new[1:-1],diff_central(psi_new,dl_B_new)),k=3,s=0,ext=&quot;const&quot;)</span>
<span class="c1">#     term1 = lambda x: gamma*x/U(x)*(dUdpsi(x))**2</span>
<span class="c1">#     term2 = lambda x: dUdpsi(x) + x*d2Udpsi2(x)</span>
<span class="c1">#     F = lambda x: term1(x) - term2(x)</span>
<span class="c1">#     if plotit:</span>
<span class="c1">#         z0_idx = np.abs(Z[:,0]).argmin()</span>
<span class="c1">#         end_idx = np.abs(Rho[z0_idx,:]-max_rho).argmin()</span>
<span class="c1">#         R_of_psi = UnivariateSpline(psi[z0_idx,0:end_idx],Rho[z0_idx,0:end_idx],s=0)</span>
<span class="c1">#         psi_test = np.linspace(psi_min,psi_edge,1000)</span>
<span class="c1">#         psi_norm = psi_test/psi_edge</span>
<span class="c1">#         fig9,(ax9a,ax9b,ax9c) = plt.subplots(3,1,sharex=&quot;col&quot;)</span>
<span class="c1">#         ax9a.plot(psi_new,dl_B_new,&quot;o&quot;)</span>
<span class="c1">#         ax9a.plot(psi_test,U(psi_test),&quot;r&quot;)</span>
<span class="c1">#         ax9b.plot(psi_new[1:-1],dUdpsi(psi_new[1:-1]),&quot;o&quot;)</span>
<span class="c1">#         ax9b.plot(psi_test,dUdpsi(psi_test),&quot;r&quot;)</span>
<span class="c1">#         ax9c.plot(psi_new[2:-2],d2Udpsi2(psi_new[2:-2]),&quot;o&quot;)</span>
<span class="c1">#         ax9c.plot(psi_test,d2Udpsi2(psi_test),&quot;r&quot;)</span>
<span class="c1">#         fig0,((ax0,ax1),(ax2,ax3)) = plt.subplots(2,2,sharex=&quot;all&quot;,figsize=(18,9))</span>
<span class="c1">#         ax0.plot(psi_new/psi_edge,dl_B_new,&quot;o&quot;)</span>
<span class="c1">#         ax0.plot(psi_norm,U(psi_test),lw=2)</span>
<span class="c1">#         ax0.set_ylabel(&quot;U&quot;)</span>
<span class="c1">#         ax0top = ax0.twiny()</span>
<span class="c1">#         new_labels = [&quot;{0:1.2f}&quot;.format(r) for r in R_of_psi(psi_edge*np.array(ax0.get_xticks()))]</span>
<span class="c1">#         ax0top.set_xticklabels(new_labels)</span>
<span class="c1">#         ax0top.set_xlabel(&quot;R (m)&quot;)</span>
<span class="c1">#         ax1.plot(psi_norm,dUdpsi(psi_test),&#39;o&#39;)</span>
<span class="c1">#         ax1.set_ylabel(&quot;U&#39;&quot;)</span>
<span class="c1">#         ax1top = ax1.twiny()</span>
<span class="c1">#         ax1top.set_xticklabels(new_labels)</span>
<span class="c1">#         ax1top.set_xlabel(&quot;R (m)&quot;)</span>
<span class="c1">#         ax2.plot(psi_norm,term1(psi_test),&#39;o&#39;)</span>
<span class="c1">#         ax2.plot(psi_norm,term2(psi_test),&#39;o&#39;)</span>
<span class="c1">#         ax2.set_xlabel(&quot;$\\psi/\\psi_{lim}$&quot;)</span>
<span class="c1">#         ax2.set_ylabel(&quot;Term1 and term2&quot;)</span>
<span class="c1">#         F_clean = dh.smooth(F(psi_test),20)</span>
<span class="c1">#         ax3.plot(psi_norm,F_clean,lw=2)</span>
<span class="c1">#         ax3.set_xlabel(&quot;$\\psi/\\psi_{lim}$&quot;)</span>
<span class="c1">#         ax3.set_ylabel(&quot;F($\\psi$)&quot;)</span>
<span class="c1">#         #ax3.set_ylim(-1.2,1.2)</span>
<span class="c1">#         plt.tight_layout()</span>
<span class="c1">#     return F</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Ethan Peterson

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30411614-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


</body>
</html>